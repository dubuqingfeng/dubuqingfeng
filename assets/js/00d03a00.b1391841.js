"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[4407],{78720:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"Wiki/programming/rust/memory/atomics-and-ordering","title":"atomics-and-ordering","description":"\u539f\u5b50\u4e0e\u5185\u5b58\u5e8f\uff08Acquire/Release/SeqCst\uff09","source":"@site/docs/Wiki/programming/rust/memory/atomics-and-ordering.md","sourceDirName":"Wiki/programming/rust/memory","slug":"/Wiki/programming/rust/memory/atomics-and-ordering","permalink":"/docs/Wiki/programming/rust/memory/atomics-and-ordering","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"aliasing-provenance-validity","permalink":"/docs/Wiki/programming/rust/memory/aliasing-provenance-validity"},"next":{"title":"borrow-advanced","permalink":"/docs/Wiki/programming/rust/memory/borrow-advanced"}}');var s=i(74848),c=i(28453);const l={},d=void 0,t={},o=[{value:"\u539f\u5b50\u4e0e\u5185\u5b58\u5e8f\uff08Acquire/Release/SeqCst\uff09",id:"\u539f\u5b50\u4e0e\u5185\u5b58\u5e8facquirereleaseseqcst",level:3},{value:"\u4e3a\u4ec0\u4e48\u9700\u8981\u539f\u5b50",id:"\u4e3a\u4ec0\u4e48\u9700\u8981\u539f\u5b50",level:4},{value:"\u5e38\u7528\u539f\u5b50\u7c7b\u578b",id:"\u5e38\u7528\u539f\u5b50\u7c7b\u578b",level:4},{value:"\u5185\u5b58\u5e8f\uff08Ordering\uff09",id:"\u5185\u5b58\u5e8fordering",level:4},{value:"compare_exchange \u4e0e\u5f31 CAS",id:"compare_exchange-\u4e0e\u5f31-cas",level:4},{value:"Fences\uff08\u6805\u680f\uff09",id:"fences\u6805\u680f",level:4},{value:"\u53cd\u6a21\u5f0f\u4e0e\u6ce8\u610f",id:"\u53cd\u6a21\u5f0f\u4e0e\u6ce8\u610f",level:4},{value:"\u5de5\u5177",id:"\u5de5\u5177",level:4}];function a(e){const n={code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"\u539f\u5b50\u4e0e\u5185\u5b58\u5e8facquirereleaseseqcst",children:"\u539f\u5b50\u4e0e\u5185\u5b58\u5e8f\uff08Acquire/Release/SeqCst\uff09"}),"\n",(0,s.jsx)(n.h4,{id:"\u4e3a\u4ec0\u4e48\u9700\u8981\u539f\u5b50",children:"\u4e3a\u4ec0\u4e48\u9700\u8981\u539f\u5b50"}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u5e76\u53d1\u4e0b\uff0c\u666e\u901a\u8bfb\u5199\u53ef\u80fd\u88ab\u7f16\u8bd1\u5668/CPU \u91cd\u6392\uff0c\u5bfc\u81f4\u6570\u636e\u7ade\u4e89\u4e0e\u53ef\u89c1\u6027\u95ee\u9898\u3002\u539f\u5b50\u64cd\u4f5c\u63d0\u4f9b\u201c\u4e0d\u53ef\u5206\u5272\u201d\u7684\u8bfb\u6539\u5199\u4e0e\u53ef\u89c1\u6027\u4fdd\u8bc1\u3002"}),"\n",(0,s.jsx)(n.h4,{id:"\u5e38\u7528\u539f\u5b50\u7c7b\u578b",children:"\u5e38\u7528\u539f\u5b50\u7c7b\u578b"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"AtomicBool/AtomicIsize/AtomicUsize/AtomicI64/..."})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"AtomicPtr<T>"}),"\uff08\u6307\u9488\u539f\u5b50\uff09"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5185\u5b58\u5e8fordering",children:"\u5185\u5b58\u5e8f\uff08Ordering\uff09"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Relaxed\uff1a\u4ec5\u4fdd\u8bc1\u539f\u5b50\u81ea\u8eab\u7684\u539f\u5b50\u6027\uff0c\u4e0d\u63d0\u4f9b\u8de8\u7ebf\u7a0b\u7684\u987a\u5e8f\u5173\u7cfb\u3002"}),"\n",(0,s.jsx)(n.li,{children:"Acquire\uff1a\u8bfb\u7aef\u83b7\u53d6\uff0c\u7981\u6b62\u5176\u540e\u64cd\u4f5c\u91cd\u6392\u5230\u524d\u9762\uff1b\u4e0e Release \u642d\u914d\u5f62\u6210\u201c\u540c\u6b65\u8fb9\u201d\uff08happens-before\uff09\u3002"}),"\n",(0,s.jsx)(n.li,{children:"Release\uff1a\u5199\u7aef\u91ca\u653e\uff0c\u7981\u6b62\u5176\u524d\u64cd\u4f5c\u91cd\u6392\u5230\u540e\u9762\u3002"}),"\n",(0,s.jsx)(n.li,{children:"AcqRel\uff1a\u8bfb\u6539\u5199\u64cd\u4f5c\u7684\u83b7\u53d6+\u91ca\u653e\u3002"}),"\n",(0,s.jsx)(n.li,{children:"SeqCst\uff1a\u6700\u5f3a\u4fdd\u8bc1\uff0c\u6240\u6709 SeqCst \u64cd\u4f5c\u5728\u5168\u5c40\u5355\u5e8f\uff08total order\uff09\u4e2d\u4e00\u81f4\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u793a\u4f8b\uff1a\u7ecf\u5178\u6d88\u606f\u4f20\u9012\uff08message passing\uff09"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use std::sync::atomic::{AtomicUsize, Ordering};\nuse std::thread;\n\nstatic DATA: AtomicUsize = AtomicUsize::new(0);\nstatic FLAG: AtomicUsize = AtomicUsize::new(0);\n\nfn main() {\n    let t = thread::spawn(|| {\n        DATA.store(42, Ordering::Relaxed);\n        FLAG.store(1, Ordering::Release); // \u53d1\u5e03\n    });\n    while FLAG.load(Ordering::Acquire) == 0 {} // \u83b7\u53d6\n    assert_eq!(DATA.load(Ordering::Relaxed), 42); // \u53ef\u89c1\n    t.join().unwrap();\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"compare_exchange-\u4e0e\u5f31-cas",children:"compare_exchange \u4e0e\u5f31 CAS"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"compare_exchange(expected, new, success, failure)"}),"\uff1a\u5728\u5339\u914d ",(0,s.jsx)(n.code,{children:"expected"})," \u65f6\u7528 ",(0,s.jsx)(n.code,{children:"success"})," \u5e8f\uff1b\u5931\u8d25\u7528 ",(0,s.jsx)(n.code,{children:"failure"})," \u5e8f\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"compare_exchange_weak"})," \u53ef\u80fd\u865a\u5047\u5931\u8d25\uff0c\u9700\u5728\u5faa\u73af\u4e2d\u91cd\u8bd5\uff1b\u67d0\u4e9b\u67b6\u6784\u4e0a\u66f4\u9ad8\u6548\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"fences\u6805\u680f",children:"Fences\uff08\u6805\u680f\uff09"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"atomic::fence(Ordering::SeqCst/Acquire/Release)"})," \u7528\u4e8e\u5728\u65e0\u9700\u5177\u4f53\u539f\u5b50\u8bfb\u5199\u65f6\u5efa\u7acb\u987a\u5e8f\u8fb9\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u53cd\u6a21\u5f0f\u4e0e\u6ce8\u610f",children:"\u53cd\u6a21\u5f0f\u4e0e\u6ce8\u610f"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6df7\u7528\u539f\u5b50\u4e0e\u975e\u539f\u5b50\u8bbf\u95ee\u540c\u4e00\u4f4d\u7f6e\uff08\u6570\u636e\u7ade\u4e89\uff09"}),"\n",(0,s.jsx)(n.li,{children:"\u8fc7\u5ea6\u4f7f\u7528 SeqCst\uff0c\u964d\u4f4e\u6027\u80fd\uff1b\u4f46\u4e5f\u4e0d\u8981\u4f7f\u7528\u8fc7\u5f31\u7684\u5e8f\u5bfc\u81f4\u7ade\u6001"}),"\n",(0,s.jsx)(n.li,{children:"\u5ffd\u7565\u201c\u62c6\u7bb1\u201d\u95ee\u9898\uff1a\u5c06\u591a\u4e2a\u76f8\u5173\u5b57\u6bb5\u62c6\u6210\u72ec\u7acb\u539f\u5b50\u53ef\u80fd\u6253\u7834\u4e0d\u53d8\u91cf\uff0c\u9700\u8981\u989d\u5916\u540c\u6b65"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5de5\u5177",children:"\u5de5\u5177"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"loom"}),"\uff1a\u679a\u4e3e\u5e76\u53d1\u4ea4\u9519\u6d4b\u8bd5\u7b97\u6cd5\u6b63\u786e\u6027"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ThreadSanitizer"}),"\uff1a\u68c0\u6d4b\u6570\u636e\u7ade\u4e89\uff08\u6ce8\u610f\u5bf9 Rust/async \u7684\u652f\u6301\u8303\u56f4\uff09"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>d});var r=i(96540);const s={},c=r.createContext(s);function l(e){const n=r.useContext(c);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(c.Provider,{value:n},e.children)}}}]);