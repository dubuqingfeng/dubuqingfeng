"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[6201],{44787:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>l,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"code/python/newrelease-addrepo","title":"newrelease-addrepo","description":"","source":"@site/docs/code/python/newrelease-addrepo.md","sourceDirName":"code/python","slug":"/code/python/newrelease-addrepo","permalink":"/docs/code/python/newrelease-addrepo","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"byte2str","permalink":"/docs/code/python/byte2str"},"next":{"title":"trace","permalink":"/docs/code/python/trace/"}}');var s=r(74848),o=r(28453);const a={},i=void 0,c={},d=[];function p(e){const n={code:"code",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import csv\nimport subprocess\nimport time\n\n# \u5b9a\u4e49 CSV \u6587\u4ef6\u8def\u5f84\ncsv_file_path = \'repositories.csv\'\n\n# \u5b9a\u4e49\u547d\u4ee4\u6a21\u677f\ncommand_template = (\n    "./newreleases project add github {repo_name} --webhook xxx "\n    "--webhook xxx --tag xxx"\n)\n\n# \u6700\u5927\u91cd\u8bd5\u6b21\u6570\nmax_retries = 5\n\ndef execute_command_with_retry(command, max_retries=5):\n    retries = 0\n    delay = 4  # \u521d\u59cb\u5ef6\u8fdf\u65f6\u95f4\uff08\u79d2\uff09\n\n    while retries < max_retries:\n        result = ""\n        try:\n            result = subprocess.run(command, shell=True, capture_output=True, check=False)\n            print(f"\u547d\u4ee4\u6267\u884c\u5b8c\u6210: {command} {result}")\n            if result.returncode == 0:\n                print(f"\u547d\u4ee4\u6267\u884c\u6210\u529f: {command} {result}")\n                return True\n            if str(result.stderr) is not None:\n                error_message = str(result.stderr).lower()\n                print(str(result.stderr).lower())\n                if "error: too many requests" in error_message:\n                    retries += 1\n                    print(f"\u8bf7\u6c42\u8fc7\u591a\uff0c\u91cd\u8bd5\u7b2c {retries} \u6b21\uff0c\u5ef6\u8fdf {delay} \u79d2\u540e\u91cd\u8bd5...")\n                    time.sleep(delay)\n                    delay *= 2  # \u6307\u6570\u9000\u907f\uff0c\u5ef6\u8fdf\u65f6\u95f4\u7ffb\u500d\n                    continue\n                elif "error: project already added." in error_message:\n                    print(f"\u547d\u4ee4\u6267\u884c\u5931\u8d25\uff08\'project already added.\' \u9519\u8bef\uff09: {error_message}")\n                    return True\n                else:\n                    print(f"\u547d\u4ee4\u6267\u884c\u5931\u8d25\uff08\u975e \'too many requests\' \u9519\u8bef\uff09: {error_message}")\n                    return False\n            else:\n                return True\n        except subprocess.CalledProcessError as e:\n            error_message = str(e)\n    print(f"\u8fbe\u5230\u6700\u5927\u91cd\u8bd5\u6b21\u6570 ({max_retries})\uff0c\u547d\u4ee4\u5931\u8d25: {command}")\n    return False\n\ndef filter_and_execute(csv_file_path):\n    try:\n        # \u8bfb\u53d6 CSV \u6587\u4ef6\u5185\u5bb9\u5230\u5217\u8868\n        with open(csv_file_path, \'r\', encoding=\'utf-8\') as csvfile:\n            reader = csv.reader(csvfile)\n            rows = list(reader)\n\n        # \u7b2c\u4e00\u884c\u4e3a\u8868\u5934\n        header = rows[0]\n        data = rows[1:]\n\n        # \u7528\u4e8e\u5b58\u50a8\u672a\u5904\u7406\u7684\u884c\n        remaining_rows = [header]\n\n        for row in data:\n            if len(row) < 2:\n                continue\n\n            # \u63d0\u53d6\u4ed3\u5e93\u540d\u79f0\n            repo_names = row[1]\n\n            # \u62c6\u5206\u591a\u4e2a\u4ed3\u5e93\u540d\u79f0\uff0c\u5e76\u8fc7\u6ee4\u6389\u5305\u542b\u62ec\u53f7\u7684\u6761\u76ee\n            filtered_repos = [\n                repo.strip() for repo in repo_names.split(\',\') if \'(\' not in repo\n            ]\n\n            success = True\n            for repo in filtered_repos:\n                if repo == "none":\n                    continue\n                command = command_template.format(repo_name=repo)\n                print(f"\u6267\u884c\u547d\u4ee4: {command}")\n\n                # \u8c03\u7528\u547d\u4ee4\u5e76\u5904\u7406\u91cd\u8bd5\u903b\u8f91\n                success = execute_command_with_retry(command, max_retries)\n                if not success:\n                    print(f"\u4ed3\u5e93 {repo} \u7684\u5904\u7406\u5931\u8d25\uff0c\u8df3\u8fc7...")\n                    break  # \u5982\u679c\u5f53\u524d\u884c\u7684\u67d0\u4e2a\u547d\u4ee4\u5931\u8d25\uff0c\u4fdd\u7559\u8be5\u884c\n\n                # \u6b63\u5e38\u6267\u884c\u65f6\u7684\u56fa\u5b9a\u5ef6\u8fdf\n                time.sleep(1)\n\n            # \u5982\u679c\u6210\u529f\u5904\u7406\u6574\u884c\uff0c\u5219\u4e0d\u52a0\u5165\u5269\u4f59\u884c\n            if not success:\n                remaining_rows.append(row)\n\n        # \u8986\u76d6\u5199\u5165 CSV \u6587\u4ef6\uff0c\u4ec5\u5199\u5165\u672a\u5904\u7406\u7684\u884c\n        with open(csv_file_path, \'w\', encoding=\'utf-8\', newline=\'\') as csvfile:\n            writer = csv.writer(csvfile)\n            writer.writerows(remaining_rows)\n\n        print(f"CSV \u6587\u4ef6\u5df2\u66f4\u65b0\uff0c\u4ec5\u4fdd\u7559\u672a\u5904\u7406\u7684\u884c\uff0c\u5171 {len(remaining_rows) - 1} \u6761\u8bb0\u5f55\u3002")\n\n    except Exception as e:\n        print(f"\u53d1\u751f\u9519\u8bef: {e}")\n\n# \u6267\u884c\u51fd\u6570\nfilter_and_execute(csv_file_path)\n'})})}function l(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>i});var t=r(96540);const s={},o=t.createContext(s);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);