"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[1559],{39675:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"Wiki/programming/lua/openresty","title":"OpenResty/Nginx + Lua \u5b9e\u6218","description":"\u57fa\u4e8e OpenResty \u5728 Nginx \u9636\u6bb5\u94a9\u5165 Lua\uff0c\u5b9e\u73b0\u9ad8\u6027\u80fd\u7f51\u5173/\u8fb9\u8f66\u903b\u8f91\u3002","source":"@site/docs/Wiki/programming/lua/openresty.md","sourceDirName":"Wiki/programming/lua","slug":"/Wiki/programming/lua/openresty","permalink":"/docs/Wiki/programming/lua/openresty","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"OpenResty/Nginx + Lua \u5b9e\u6218"},"sidebar":"tutorialSidebar","previous":{"title":"\u6a21\u5757\u3001\u5305\u7ba1\u7406\u4e0e\u4f9d\u8d56","permalink":"/docs/Wiki/programming/lua/modules-packaging"},"next":{"title":"Redis \u811a\u672c\u4e0e\u539f\u5b50\u64cd\u4f5c","permalink":"/docs/Wiki/programming/lua/redis-scripting"}}');var r=i(74848),s=i(28453);const l={title:"OpenResty/Nginx + Lua \u5b9e\u6218"},a=void 0,c={},o=[{value:"\u9636\u6bb5\u4e0e\u6307\u4ee4",id:"\u9636\u6bb5\u4e0e\u6307\u4ee4",level:2},{value:"\u5171\u4eab\u5b57\u5178\u4e0e\u9650\u6d41",id:"\u5171\u4eab\u5b57\u5178\u4e0e\u9650\u6d41",level:2},{value:"\u4e0e\u4e0b\u6e38\u4ea4\u4e92",id:"\u4e0e\u4e0b\u6e38\u4ea4\u4e92",level:2}];function d(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"\u57fa\u4e8e OpenResty \u5728 Nginx \u9636\u6bb5\u94a9\u5165 Lua\uff0c\u5b9e\u73b0\u9ad8\u6027\u80fd\u7f51\u5173/\u8fb9\u8f66\u903b\u8f91\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u9636\u6bb5\u4e0e\u6307\u4ee4",children:"\u9636\u6bb5\u4e0e\u6307\u4ee4"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"init_by_lua*"}),"\u3001",(0,r.jsx)(n.code,{children:"init_worker_by_lua*"})," \u521d\u59cb\u5316\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"access_by_lua*"}),"\u3001",(0,r.jsx)(n.code,{children:"rewrite_by_lua*"}),"\u3001",(0,r.jsx)(n.code,{children:"header_filter_by_lua*"})," \u7b49\u9636\u6bb5\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5171\u4eab\u5b57\u5178\u4e0e\u9650\u6d41",children:"\u5171\u4eab\u5b57\u5178\u4e0e\u9650\u6d41"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"lua_shared_dict"})," \u5b58\u653e\u70ed\u70b9\u6570\u636e\u4e0e\u9650\u6d41\u8ba1\u6570\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:["\u7ed3\u5408 ",(0,r.jsx)(n.code,{children:"resty.limit.req"})," \u5b9e\u73b0\u6f0f\u6876\u9650\u6d41\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u793a\u4f8b Nginx \u914d\u7f6e\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:'lua_shared_dict limits 10m;\n\ninit_by_lua_block {\n  local limit_req = require "resty.limit.req"\n  rate_limiter, err = limit_req.new("limits", 100, 200) -- 100 r/s, burst 200\n}\n\nserver {\n  location /api {\n    access_by_lua_block {\n      local delay, err = rate_limiter:incoming("api", true)\n      if not delay then\n        ngx.status = 429; ngx.say("Too Many Requests"); return ngx.exit(429)\n      end\n      if delay > 0 then ngx.sleep(delay) end\n    }\n    proxy_pass http://backend;\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e0e\u4e0b\u6e38\u4ea4\u4e92",children:"\u4e0e\u4e0b\u6e38\u4ea4\u4e92"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"lua-resty-http"})," \u8c03\u7528\u540e\u7aef\uff1b\u7f13\u5b58\u4e0e\u7194\u65ad\u91cd\u8bd5\u7b56\u7565\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-lua",children:"local http = require 'resty.http'\nlocal cli = http.new()\ncli:set_timeout(200)\nlocal res, err = cli:request_uri('http://127.0.0.1:8080/health', { method = 'GET' })\nif not res or res.status ~= 200 then\n  ngx.status = 502; ngx.say('bad gateway')\nelse\n  ngx.say(res.body)\nend\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>a});var t=i(96540);const r={},s=t.createContext(r);function l(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);