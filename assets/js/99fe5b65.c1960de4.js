"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[8860],{22424:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>a,frontMatter:()=>c,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"Wiki/programming/rust/perf/performance-optimization","title":"performance-optimization","description":"\u6027\u80fd\u4e0e\u4f18\u5316\u624b\u6bb5","source":"@site/docs/Wiki/programming/rust/perf/performance-optimization.md","sourceDirName":"Wiki/programming/rust/perf","slug":"/Wiki/programming/rust/perf/performance-optimization","permalink":"/docs/Wiki/programming/rust/perf/performance-optimization","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"variance-phantomdata","permalink":"/docs/Wiki/programming/rust/memory/variance-phantomdata"},"next":{"title":"testing","permalink":"/docs/Wiki/programming/rust/testing/"}}');var l=i(74848),s=i(28453);const c={},d=void 0,o={},h=[{value:"\u6027\u80fd\u4e0e\u4f18\u5316\u624b\u6bb5",id:"\u6027\u80fd\u4e0e\u4f18\u5316\u624b\u6bb5",level:3},{value:"\u5ea6\u91cf\u5148\u884c",id:"\u5ea6\u91cf\u5148\u884c",level:4},{value:"\u6784\u5efa\u7ea7\u4f18\u5316",id:"\u6784\u5efa\u7ea7\u4f18\u5316",level:4},{value:"\u4ee3\u7801\u7ea7\u4f18\u5316",id:"\u4ee3\u7801\u7ea7\u4f18\u5316",level:4},{value:"I/O \u4e0e\u7cfb\u7edf",id:"io-\u4e0e\u7cfb\u7edf",level:4},{value:"\u5178\u578b\u53d6\u820d",id:"\u5178\u578b\u53d6\u820d",level:4},{value:"\u6392\u67e5\u6e05\u5355",id:"\u6392\u67e5\u6e05\u5355",level:4}];function t(e){const n={code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h3,{id:"\u6027\u80fd\u4e0e\u4f18\u5316\u624b\u6bb5",children:"\u6027\u80fd\u4e0e\u4f18\u5316\u624b\u6bb5"}),"\n",(0,l.jsx)(n.h4,{id:"\u5ea6\u91cf\u5148\u884c",children:"\u5ea6\u91cf\u5148\u884c"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u57fa\u51c6\uff1a",(0,l.jsx)(n.code,{children:"criterion"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u706b\u7130\u56fe\uff1a",(0,l.jsx)(n.code,{children:"perf"}),"/",(0,l.jsx)(n.code,{children:"dtrace"})," + ",(0,l.jsx)(n.code,{children:"inferno"}),"\uff08flamegraph\uff09"]}),"\n",(0,l.jsxs)(n.li,{children:["\u4f53\u79ef\u4e0e\u5355\u6001\u5316\uff1a",(0,l.jsx)(n.code,{children:"cargo-bloat"}),"\u3001",(0,l.jsx)(n.code,{children:"cargo-llvm-lines"}),"\u3001",(0,l.jsx)(n.code,{children:"cargo-size"})]}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"\u6784\u5efa\u7ea7\u4f18\u5316",children:"\u6784\u5efa\u7ea7\u4f18\u5316"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"Cargo.toml"}),"\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'[profile.release]\nopt-level = 3\nlto = "thin"      # \u6216 true\uff08fat LTO\uff0c\u66f4\u6162\u4f46\u6709\u65f6\u66f4\u5feb\uff09\ncodegen-units = 1 # \u63d0\u5347\u4f18\u5316\u7a7a\u95f4\uff0c\u6784\u5efa\u66f4\u6162\npanic = "abort"   # \u65e0\u56de\u6eaf\u5c55\u5f00\uff0c\u51cf\u5c0f\u4f53\u79ef/\u52a0\u901f\nstrip = "symbols" # \u9700\u8981 1.70+\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u6309\u76ee\u6807 CPU \u4f18\u5316\uff08\u672c\u5730\u6784\u5efa/\u5bb9\u5668\u5185\uff09\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'RUSTFLAGS="-C target-cpu=native" cargo build --release\n'})}),"\n",(0,l.jsx)(n.p,{children:"PGO\uff08\u6982\u8981\u5bfc\u5411\u4f18\u5316\uff09\u4e0e BOLT\uff1a"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u7528\u4ee3\u8868\u6027\u8d1f\u8f7d\u751f\u6210 profile -> \u5e26\u5165\u7f16\u8bd1 -> \u590d\u6d4b\u9a8c\u8bc1"}),"\n",(0,l.jsxs)(n.li,{children:["LLVM PGO \u6d41\u7a0b\uff1a",(0,l.jsx)(n.code,{children:"-C profile-generate=/path"})," -> \u8dd1\u5de5\u4f5c\u8d1f\u8f7d -> ",(0,l.jsx)(n.code,{children:"-C profile-use=/path"})]}),"\n",(0,l.jsx)(n.li,{children:"BOLT \u5bf9\u4e8c\u8fdb\u5236\u91cd\u65b0\u5e03\u5c40\uff0c\u5e38\u7528\u4e8e\u670d\u52a1\u7aef\u70ed\u70b9\u51fd\u6570"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"\u4ee3\u7801\u7ea7\u4f18\u5316",children:"\u4ee3\u7801\u7ea7\u4f18\u5316"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u5185\u5b58/\u5206\u914d","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u590d\u7528\u7f13\u51b2\u533a\uff1b\u907f\u514d\u4e0d\u5fc5\u8981\u7684 ",(0,l.jsx)(n.code,{children:"clone()"}),"\uff1b\u503e\u5411 ",(0,l.jsx)(n.code,{children:"&str"}),"/",(0,l.jsx)(n.code,{children:"&[u8]"}),"\uff1b\u5fc5\u8981\u65f6\u7528 ",(0,l.jsx)(n.code,{children:"Cow<'_, T>"})]}),"\n",(0,l.jsxs)(n.li,{children:["\u5c0f\u578b\u5bb9\u5668\uff1a",(0,l.jsx)(n.code,{children:"smallvec"}),"/",(0,l.jsx)(n.code,{children:"arrayvec"}),"\uff1b\u5206\u914d\u5668\uff1a",(0,l.jsx)(n.code,{children:"mimalloc"}),"/",(0,l.jsx)(n.code,{children:"jemalloc"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u8c03\u5ea6/\u5e76\u53d1","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u9009\u62e9\u5408\u9002\u7684\u5e76\u53d1\u7ed3\u6784\uff1a",(0,l.jsx)(n.code,{children:"crossbeam"})," \u7684\u65e0\u9501\u961f\u5217\u3001",(0,l.jsx)(n.code,{children:"parking_lot"})," \u9501\uff1b\u51cf\u5c11\u4e34\u754c\u533a\u4e0e\u4e89\u7528"]}),"\n",(0,l.jsxs)(n.li,{children:["\u539f\u5b50\u5e8f\u5c3d\u91cf\u524a\u5f31\u5230 ",(0,l.jsx)(n.code,{children:"Acquire/Release"})," \u800c\u975e ",(0,l.jsx)(n.code,{children:"SeqCst"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u7b97\u6cd5/\u6570\u636e\u7ed3\u6784","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Hash\uff1a\u5bf9\u6027\u80fd\u654f\u611f\u53ef\u7528 ",(0,l.jsx)(n.code,{children:"ahash"}),"/",(0,l.jsx)(n.code,{children:"rustc-hash"}),"\uff08\u6ce8\u610f\u5b89\u5168\u6743\u8861\uff09"]}),"\n",(0,l.jsxs)(n.li,{children:["\u9009\u62e9\u5408\u9002\u5bb9\u5668\uff1a",(0,l.jsx)(n.code,{children:"Vec"}),"/",(0,l.jsx)(n.code,{children:"VecDeque"}),"/",(0,l.jsx)(n.code,{children:"BTreeMap"}),"/",(0,l.jsx)(n.code,{children:"FxHashMap"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\u5206\u652f\u4e0e\u5185\u8054","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u6807\u6ce8\u51b7\u8def\u5f84\uff1a",(0,l.jsx)(n.code,{children:"#[cold]"}),"\uff1b\u70ed\u70b9\u53ef\u8003\u8651 ",(0,l.jsx)(n.code,{children:"#[inline]"}),"/",(0,l.jsx)(n.code,{children:"#[inline(always)]"}),"\uff08\u8c28\u614e\u9632\u6b62\u81a8\u80c0\uff09"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["SIMD/\u5e76\u884c","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"rayon"})," \u6570\u636e\u5e76\u884c\uff1bSIMD \u53ef\u770b ",(0,l.jsx)(n.code,{children:"std::simd"}),"\uff08nightly\uff09\u6216\u7b2c\u4e09\u65b9\u5e93"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"io-\u4e0e\u7cfb\u7edf",children:"I/O \u4e0e\u7cfb\u7edf"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\u6279\u91cf\u4e0e\u7f13\u51b2\uff1a",(0,l.jsx)(n.code,{children:"BufReader/BufWriter"}),"\uff1b\u51cf\u5c11\u7cfb\u7edf\u8c03\u7528\u6b21\u6570"]}),"\n",(0,l.jsxs)(n.li,{children:["\u96f6\u62f7\u8d1d\uff1a",(0,l.jsx)(n.code,{children:"sendfile"}),"/",(0,l.jsx)(n.code,{children:"mmap"}),"\uff08\u6743\u8861\u590d\u6742\u5ea6\u4e0e\u5b89\u5168\u6027\uff09"]}),"\n",(0,l.jsx)(n.li,{children:"\u7f51\u7edc\uff1a\u9009\u62e9\u5408\u9002\u5f02\u6b65\u8fd0\u884c\u65f6\uff08Tokio\uff09\uff0c\u4f7f\u7528\u8fde\u63a5\u6c60\u3001\u8d85\u65f6\u4e0e backoff"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"\u5178\u578b\u53d6\u820d",children:"\u5178\u578b\u53d6\u820d"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6cdb\u578b\u5355\u6001\u5316 vs Trait \u5bf9\u8c61\uff1a\u524d\u8005\u5feb\u4f46\u53ef\u80fd\u4ee3\u7801\u81a8\u80c0\uff1b\u540e\u8005\u4f53\u79ef\u5c0f\u4f46\u6709\u865a\u8c03\u7528\u5f00\u9500"}),"\n",(0,l.jsx)(n.li,{children:"\u91ca\u653e\u68c0\u67e5/\u8c03\u8bd5\u4fe1\u606f\uff1a\u5f00\u53d1\u6001\u4fdd\u7559\u53ef\u89c2\u6d4b\u6027\uff0c\u53d1\u5e03\u6001\u79fb\u9664"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"\u6392\u67e5\u6e05\u5355",children:"\u6392\u67e5\u6e05\u5355"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u57fa\u51c6\u662f\u5426\u7a33\u5b9a\u3001\u662f\u5426\u70ed\u8eab"}),"\n",(0,l.jsx)(n.li,{children:"\u70ed\u70b9\u662f\u5426\u5185\u8054/\u53bb\u865a\u8c03\u7528/\u53bb\u8fb9\u754c\u68c0\u67e5\uff08\u5728\u5b89\u5168\u524d\u63d0\u4e0b\uff09"}),"\n",(0,l.jsx)(n.li,{children:"\u5206\u914d\u70ed\u70b9\uff1a\u662f\u5426\u80fd\u632a\u5230\u6808\u4e0a\u6216\u590d\u7528"}),"\n",(0,l.jsx)(n.li,{children:"Hash \u70ed\u70b9\uff1a\u662f\u5426\u6362\u66f4\u5feb\u7684 hasher"}),"\n",(0,l.jsx)(n.li,{children:"\u9501\u4e89\u7528\uff1a\u662f\u5426\u53ef\u5206\u7247/\u7f29\u5c0f\u4e34\u754c\u533a/\u6539\u65e0\u9501"}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(t,{...e})}):t(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>d});var r=i(96540);const l={},s=r.createContext(l);function c(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);