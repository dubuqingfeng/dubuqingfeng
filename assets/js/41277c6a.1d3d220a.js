"use strict";(globalThis.webpackChunkdubuqingfeng=globalThis.webpackChunkdubuqingfeng||[]).push([[17329],{28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>c});var r=i(96540);const s={},l=r.createContext(s);function d(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),r.createElement(l.Provider,{value:n},e.children)}},98652:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"Wiki/programming/rust/memory/unsafe-and-model","title":"unsafe-and-model","description":"unsafe \u4e0e\u5185\u5b58\u6a21\u578b","source":"@site/docs/Wiki/programming/rust/memory/unsafe-and-model.md","sourceDirName":"Wiki/programming/rust/memory","slug":"/Wiki/programming/rust/memory/unsafe-and-model","permalink":"/docs/Wiki/programming/rust/memory/unsafe-and-model","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"pointers-slices-safety","permalink":"/docs/Wiki/programming/rust/memory/pointers-slices-safety"},"next":{"title":"variance-phantomdata","permalink":"/docs/Wiki/programming/rust/memory/variance-phantomdata"}}');var s=i(74848),l=i(28453);const d={},c=void 0,o={},a=[{value:"unsafe \u4e0e\u5185\u5b58\u6a21\u578b",id:"unsafe-\u4e0e\u5185\u5b58\u6a21\u578b",level:3},{value:"unsafe \u80fd\u505a\u4ec0\u4e48",id:"unsafe-\u80fd\u505a\u4ec0\u4e48",level:4},{value:"Rust \u5185\u5b58\u6a21\u578b\u8981\u70b9",id:"rust-\u5185\u5b58\u6a21\u578b\u8981\u70b9",level:4},{value:"\u5e38\u89c1\u573a\u666f\u4e0e\u8303\u5f0f",id:"\u5e38\u89c1\u573a\u666f\u4e0e\u8303\u5f0f",level:4},{value:"\u6700\u5c0f\u793a\u4f8b\uff08\u8bf7\u52ff\u5728\u751f\u4ea7\u4e2d\u88f8\u7528\uff09",id:"\u6700\u5c0f\u793a\u4f8b\u8bf7\u52ff\u5728\u751f\u4ea7\u4e2d\u88f8\u7528",level:4},{value:"\u5c01\u88c5\u539f\u5219\uff08\u5173\u952e\uff09",id:"\u5c01\u88c5\u539f\u5219\u5173\u952e",level:4},{value:"\u8c03\u8bd5\u4e0e\u9a8c\u8bc1\u5de5\u5177",id:"\u8c03\u8bd5\u4e0e\u9a8c\u8bc1\u5de5\u5177",level:4},{value:"\u5ef6\u4f38\u9605\u8bfb\uff08\u66f4\u6df1\u5165\u4e13\u9898\uff09",id:"\u5ef6\u4f38\u9605\u8bfb\u66f4\u6df1\u5165\u4e13\u9898",level:4}];function t(e){const n={a:"a",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"unsafe-\u4e0e\u5185\u5b58\u6a21\u578b",children:"unsafe \u4e0e\u5185\u5b58\u6a21\u578b"}),"\n",(0,s.jsx)(n.h4,{id:"unsafe-\u80fd\u505a\u4ec0\u4e48",children:"unsafe \u80fd\u505a\u4ec0\u4e48"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u89e3\u5f15\u7528\u88f8\u6307\u9488\uff1a",(0,s.jsx)(n.code,{children:"*const T"})," / ",(0,s.jsx)(n.code,{children:"*mut T"})]}),"\n",(0,s.jsxs)(n.li,{children:["\u8c03\u7528 ",(0,s.jsx)(n.code,{children:"unsafe fn"})," \u6216\u5305\u542b ",(0,s.jsx)(n.code,{children:"unsafe"})," \u4ee3\u7801\u5757"]}),"\n",(0,s.jsxs)(n.li,{children:["\u8bbf\u95ee/\u4fee\u6539\u53ef\u53d8\u9759\u6001\u53d8\u91cf\uff1a",(0,s.jsx)(n.code,{children:"static mut"})]}),"\n",(0,s.jsxs)(n.li,{children:["\u4e0e\u5916\u90e8\uff08FFI\uff09\u4ea4\u4e92\uff1a",(0,s.jsx)(n.code,{children:'extern "C"'}),"\u3001",(0,s.jsx)(n.code,{children:"#[no_mangle]"})]}),"\n",(0,s.jsxs)(n.li,{children:["\u8bfb\u5199 ",(0,s.jsx)(n.code,{children:"union"})," \u5b57\u6bb5\u3001\u624b\u52a8\u7ba1\u7406\u5e03\u5c40/\u5bf9\u9f50\uff08",(0,s.jsx)(n.code,{children:"#[repr(C)]"}),"/",(0,s.jsx)(n.code,{children:"align"}),"\uff09"]}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"unsafe \u53ea\u5141\u8bb8\u505a\u201c\u6f5c\u5728\u4e0d\u5b89\u5168\u201d\u7684\u4e8b\uff0c\u4f46\u4e0d\u4fdd\u8bc1\u4e00\u5b9a\u5b89\u5168\uff1b\u6b63\u786e\u6027\u53d6\u51b3\u4e8e\u4f60\u7ef4\u62a4\u7684\u4e0d\u53d8\u91cf\uff08invariants\uff09\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"rust-\u5185\u5b58\u6a21\u578b\u8981\u70b9",children:"Rust \u5185\u5b58\u6a21\u578b\u8981\u70b9"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u522b\u540d\u4e0e\u53ef\u53d8\u6027\uff1a\u540c\u4e00\u65f6\u523b\u201c\u8981\u4e48\u591a\u4e2a\u4e0d\u53ef\u53d8\u5f15\u7528\uff0c\u8981\u4e48\u4e00\u4e2a\u53ef\u53d8\u5f15\u7528\u201d"}),"\n",(0,s.jsx)(n.li,{children:"\u6570\u636e\u7ade\u4e89\u5373\u672a\u5b9a\u4e49\u884c\u4e3a\uff08UB\uff09\uff1a\u4e24\u4e2a\u6216\u4ee5\u4e0a\u7ebf\u7a0b\u540c\u65f6\u5199/\u8bfb\u5199\u540c\u4e00\u5185\u5b58\u4e14\u65e0\u540c\u6b65"}),"\n",(0,s.jsx)(n.li,{children:"\u5bf9\u9f50\u4e0e\u6709\u6548\u6027\uff08validity/provenance\uff09\uff1a\u89e3\u5f15\u7528\u5fc5\u987b\u6ee1\u8db3\u5bf9\u9f50\u3001\u751f\u547d\u5468\u671f\u3001\u521d\u59cb\u5316\u7b49\u524d\u63d0"}),"\n",(0,s.jsxs)(n.li,{children:["\u539f\u5b50\u8bed\u4e49\uff1a\u901a\u8fc7 ",(0,s.jsx)(n.code,{children:"std::sync::atomic"})," \u6307\u5b9a\u5185\u5b58\u5e8f\uff08",(0,s.jsx)(n.code,{children:"Relaxed/Acquire/Release/AcqRel/SeqCst"}),"\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7ebf\u7a0b\u5b89\u5168\u7531 ",(0,s.jsx)(n.code,{children:"Send/Sync"})," \u51b3\u5b9a\uff1a\u8de8\u7ebf\u7a0b\u79fb\u52a8\uff08Send\uff09/\u5171\u4eab\uff08Sync\uff09"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u53c2\u8003\uff1aRustonomicon\u3001Unsafe Code Guidelines\uff08UCG\uff09"}),"\n",(0,s.jsx)(n.h4,{id:"\u5e38\u89c1\u573a\u666f\u4e0e\u8303\u5f0f",children:"\u5e38\u89c1\u573a\u666f\u4e0e\u8303\u5f0f"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"FFI\uff1a\u4e0e C \u4ea4\u6362\u6307\u9488/\u7f13\u51b2\u533a\u3001\u9075\u5b88\u5bf9\u9f50\u4e0e\u6240\u6709\u6743\u8f6c\u79fb\u7ea6\u5b9a"}),"\n",(0,s.jsxs)(n.li,{children:["Zero-copy\uff1a",(0,s.jsx)(n.code,{children:"from_raw_parts"}),"/",(0,s.jsx)(n.code,{children:"from_raw_parts_mut"})," \u6784\u9020\u5207\u7247\uff08\u9700\u786e\u4fdd\u5bb9\u91cf\u4e0e\u5bf9\u9f50\u6b63\u786e\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["\u81ea\u5b9a\u4e49\u540c\u6b65/\u5bb9\u5668\uff1a\u57fa\u4e8e ",(0,s.jsx)(n.code,{children:"UnsafeCell"})," \u6253\u7834\u5171\u4eab\u4e0d\u53ef\u53d8\uff0c\u4e25\u683c\u5c01\u88c5\u8fb9\u754c"]}),"\n",(0,s.jsx)(n.li,{children:"\u5185\u5b58\u6620\u5c04\u4e0e DMA\uff1a\u5bf9\u9f50\u3001\u7f13\u5b58\u4e00\u81f4\u6027\u3001\u987a\u5e8f\u4fdd\u8bc1\u9700\u683c\u5916\u8c28\u614e"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u6700\u5c0f\u793a\u4f8b\u8bf7\u52ff\u5728\u751f\u4ea7\u4e2d\u88f8\u7528",children:"\u6700\u5c0f\u793a\u4f8b\uff08\u8bf7\u52ff\u5728\u751f\u4ea7\u4e2d\u88f8\u7528\uff09"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn raw_demo() {\n    let mut v = vec![10, 20, 30];\n    let p = v.as_mut_ptr();\n    unsafe {\n        // \u5408\u6cd5\u524d\u63d0\uff1ap \u6307\u5411\u7684\u5185\u5b58\u4ecd\u5f52 v \u6240\u6709\uff0c\u672a\u8d8a\u754c\uff0c\u4e14\u5bf9\u9f50\n        *p.add(1) = 99; // \u4fee\u6539\u7b2c\u4e8c\u4e2a\u5143\u7d20\n    }\n    assert_eq!(v[1], 99);\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"\u5c01\u88c5\u539f\u5219\u5173\u952e",children:"\u5c01\u88c5\u539f\u5219\uff08\u5173\u952e\uff09"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u5c06 ",(0,s.jsx)(n.code,{children:"unsafe"})," \u5c3d\u53ef\u80fd\u5c01\u88c5\u5728\u5c0f\u51fd\u6570\u5185\uff0c\u5411\u5916\u66b4\u9732\u201c\u5b8c\u5168\u5b89\u5168\u201d\u7684 API"]}),"\n",(0,s.jsx)(n.li,{children:"\u660e\u786e\u5199\u4e0b\u4e0d\u53d8\u91cf\uff1a\u5bf9\u9f50\u3001\u8d8a\u754c\u3001\u522b\u540d\u3001\u751f\u547d\u5468\u671f\u3001\u7ebf\u7a0b\u5b89\u5168\u7b49\u524d\u63d0\u6761\u4ef6"}),"\n",(0,s.jsxs)(n.li,{children:["\u5355\u5143\u6d4b\u8bd5 + ",(0,s.jsx)(n.code,{children:"Miri"}),"/Sanitizer/",(0,s.jsx)(n.code,{children:"loom"})," \u9a8c\u8bc1\u5e76\u53d1\u4e0e\u5185\u5b58\u8bbf\u95ee"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u8c03\u8bd5\u4e0e\u9a8c\u8bc1\u5de5\u5177",children:"\u8c03\u8bd5\u4e0e\u9a8c\u8bc1\u5de5\u5177"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Miri\uff1a",(0,s.jsx)(n.code,{children:"cargo +nightly miri test"})," \u68c0\u67e5\u672a\u5b9a\u4e49\u884c\u4e3a"]}),"\n",(0,s.jsxs)(n.li,{children:["Sanitizers\uff1a",(0,s.jsx)(n.code,{children:"ASan"}),"/",(0,s.jsx)(n.code,{children:"TSan"}),"/",(0,s.jsx)(n.code,{children:"UBSan"}),"\uff08",(0,s.jsx)(n.code,{children:"RUSTFLAGS"})," \u914d\u7f6e\u6216 ",(0,s.jsx)(n.code,{children:"-Z sanitizer"}),"\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"loom"}),"\uff1a\u679a\u4e3e\u5e76\u53d1\u4ea4\u9519\u4ee5\u53d1\u73b0\u6570\u636e\u7ade\u4e89"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5ef6\u4f38\u9605\u8bfb\u66f4\u6df1\u5165\u4e13\u9898",children:"\u5ef6\u4f38\u9605\u8bfb\uff08\u66f4\u6df1\u5165\u4e13\u9898\uff09"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/aliasing-provenance-validity",children:"\u522b\u540d\u3001\u8d77\u6e90\uff08provenance\uff09\u4e0e\u6709\u6548\u6027"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/atomics-and-ordering",children:"\u539f\u5b50\u4e0e\u5185\u5b58\u5e8f\uff08Acquire/Release/SeqCst\uff09"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/pin-self-referential",children:"Pin \u4e0e\u81ea\u5f15\u7528\u7c7b\u578b\u3001\u4e0d\u52a8\u6027"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/layout-repr-niches",children:"\u5185\u5b58\u5e03\u5c40\u4e0e repr\u3001niche \u4f18\u5316"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/variance-phantomdata",children:"\u65b9\u5dee\u4e0e PhantomData\u3001Drop \u68c0\u67e5"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/interior-mutability",children:"\u5185\u90e8\u53ef\u53d8\u6027\uff1aUnsafeCell/Cell/RefCell"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/borrow-advanced",children:"\u501f\u7528\u68c0\u67e5\u8fdb\u9636\uff1aNLL\u3001\u4e24\u9636\u6bb5\u501f\u7528\u3001\u91cd\u501f\u7528"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/pointers-slices-safety",children:"\u6307\u9488\u4e0e\u5207\u7247\u5b89\u5168\u8fb9\u754c"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/Wiki/programming/rust/memory/drop-unwind-abort",children:"Drop \u987a\u5e8f\u4e0e panic \u5c55\u5f00/abort"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(t,{...e})}):t(e)}}}]);