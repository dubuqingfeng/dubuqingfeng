"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[4022],{11560:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>h,contentTitle:()=>l,default:()=>p,frontMatter:()=>d,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"Wiki/blockchain/bitcoin/address/p2sh","title":"p2sh","description":"p2sh","source":"@site/docs/Wiki/blockchain/bitcoin/address/p2sh.md","sourceDirName":"Wiki/blockchain/bitcoin/address","slug":"/Wiki/blockchain/bitcoin/address/p2sh","permalink":"/docs/Wiki/blockchain/bitcoin/address/p2sh","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"p2pkh","permalink":"/docs/Wiki/blockchain/bitcoin/address/p2pkh"},"next":{"title":"p2tr","permalink":"/docs/Wiki/blockchain/bitcoin/address/p2tr"}}');var r=i(74848),c=i(28453);const d={},l=void 0,h={},t=[{value:"p2sh",id:"p2sh",level:2},{value:"\u5730\u5740\u4e0e\u811a\u672c",id:"\u5730\u5740\u4e0e\u811a\u672c",level:3},{value:"\u82b1\u8d39\u6d41\u7a0b\uff08\u89e3\u9501\uff09",id:"\u82b1\u8d39\u6d41\u7a0b\u89e3\u9501",level:3},{value:"\u4ece redeemScript \u5230\u5730\u5740\uff08\u6d41\u7a0b\uff09",id:"\u4ece-redeemscript-\u5230\u5730\u5740\u6d41\u7a0b",level:3},{value:"\u793a\u4f8b redeemScript\uff082-of-3 \u591a\u7b7e\uff09",id:"\u793a\u4f8b-redeemscript2-of-3-\u591a\u7b7e",level:3},{value:"Python \u7247\u6bb5\uff08\u4ece redeemScript \u751f\u6210 P2SH \u5730\u5740\uff09",id:"python-\u7247\u6bb5\u4ece-redeemscript-\u751f\u6210-p2sh-\u5730\u5740",level:3},{value:"\u5e38\u89c1\u9519\u8bef\u4e0e\u6392\u67e5",id:"\u5e38\u89c1\u9519\u8bef\u4e0e\u6392\u67e5",level:3},{value:"\u76f8\u5173",id:"\u76f8\u5173",level:3}];function o(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"p2sh",children:"p2sh"}),"\n",(0,r.jsx)(n.p,{children:"Pay to Script Hash\uff08\u652f\u4ed8\u5230\u811a\u672c\u54c8\u5e0c\uff09"}),"\n",(0,r.jsxs)(n.p,{children:["P2SH \u5c06\u201c\u590d\u6742\u7684\u9501\u5b9a\u6761\u4ef6\u201d\u9690\u85cf\u5728\u5730\u5740\u80cc\u540e\u3002\u5730\u5740\u672c\u8eab\u4ec5\u643a\u5e26 redeemScript \u7684 HASH160\uff0c\u4e3b\u7f51\u5730\u5740\u4ee5 ",(0,r.jsx)(n.code,{children:"3"})," \u5f00\u5934\uff0c\u6d4b\u8bd5\u7f51\u4ee5 ",(0,r.jsx)(n.code,{children:"2"})," \u5f00\u5934\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u5730\u5740\u4e0e\u811a\u672c",children:"\u5730\u5740\u4e0e\u811a\u672c"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["scriptPubKey\uff1a",(0,r.jsx)(n.code,{children:"OP_HASH160 <20-byte scriptHash> OP_EQUAL"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u5730\u5740\u7f16\u7801\uff1aBase58Check","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u7248\u672c\u524d\u7f00\uff08version\uff09\uff1a\u4e3b\u7f51 ",(0,r.jsx)(n.code,{children:"0x05"}),"\uff0c\u6d4b\u8bd5\u7f51 ",(0,r.jsx)(n.code,{children:"0xC4"})]}),"\n",(0,r.jsxs)(n.li,{children:["payload\uff1a",(0,r.jsx)(n.code,{children:"version || HASH160(redeemScript)"}),"\uff08\u5171 21 \u5b57\u8282\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["\u6821\u9a8c\u548c\uff1a",(0,r.jsx)(n.code,{children:"SHA256(SHA256(payload))[0:4]"})]}),"\n",(0,r.jsxs)(n.li,{children:["Base58Check(payload || checksum) \u2192 \u5730\u5740\uff08\u4e3b\u7f51\u4ee5 ",(0,r.jsx)(n.code,{children:"3"}),"\uff0c\u6d4b\u8bd5\u7f51\u4ee5 ",(0,r.jsx)(n.code,{children:"2"})," \u5f00\u5934\uff09"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u6ce8\u610f\uff1ascriptHash \u662f\u5bf9\u201credeemScript \u539f\u59cb\u5b57\u8282\u201d\u7684 HASH160\uff0c\u800c\u4e0d\u662f\u5bf9\u516c\u94a5\u6216\u5730\u5740\u7684\u54c8\u5e0c\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u82b1\u8d39\u6d41\u7a0b\u89e3\u9501",children:"\u82b1\u8d39\u6d41\u7a0b\uff08\u89e3\u9501\uff09"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u666e\u901a P2SH\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["scriptSig\uff1a",(0,r.jsx)(n.code,{children:"<...\u6ee1\u8db3 redeemScript \u7684\u6570\u636e...> <redeemScript>"})]}),"\n",(0,r.jsx)(n.li,{children:"\u6267\u884c\u987a\u5e8f\uff1a\u5148\u628a scriptSig \u4e0e scriptPubKey \u62fc\u63a5\u6267\u884c\uff0c\u6700\u7ec8\u5c06\u538b\u6808\u7684 redeemScript \u4f5c\u4e3a\u65b0\u7684\u811a\u672c\u6267\u884c\u3002"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"P2SH \u5305\u88c5\u9694\u79bb\u89c1\u8bc1\uff08Nested SegWit\uff09\u5e38\u89c1\u4e24\u7c7b\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["P2SH-P2WPKH\uff08BIP-141/143\uff09\uff1a","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["redeemScript\uff1a",(0,r.jsx)(n.code,{children:"0 <20-byte HASH160(pubkey)>"}),"\uff08\u5341\u516d\u8fdb\u5236\u5f62\u6001\u4e3a ",(0,r.jsx)(n.code,{children:"0014{20\u5b57\u8282}"}),"\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["scriptSig\uff1a",(0,r.jsx)(n.code,{children:"<redeemScript>"}),"\uff08\u4ec5\u63a8\u5165 redeemScript\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["\u89c1\u8bc1\u6808 witness\uff1a",(0,r.jsx)(n.code,{children:"<signature> <pubkey>"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["P2SH-P2WSH\uff1a","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["redeemScript\uff1a",(0,r.jsx)(n.code,{children:"0 <32-byte SHA256(witnessScript)>"})]}),"\n",(0,r.jsxs)(n.li,{children:["scriptSig\uff1a",(0,r.jsx)(n.code,{children:"<redeemScript>"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u89c1\u8bc1\u6808 witness\uff1a",(0,r.jsx)(n.code,{children:"<...\u6ee1\u8db3 witnessScript \u7684\u6570\u636e...> <witnessScript>"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u4ece-redeemscript-\u5230\u5730\u5740\u6d41\u7a0b",children:"\u4ece redeemScript \u5230\u5730\u5740\uff08\u6d41\u7a0b\uff09"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u8ba1\u7b97 ",(0,r.jsx)(n.code,{children:"scriptHash = RIPEMD160(SHA256(redeemScript))"}),"\uff0820 \u5b57\u8282\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["\u7ec4\u88c5 payload\uff1a",(0,r.jsx)(n.code,{children:"0x05 || scriptHash"}),"\uff08\u4e3b\u7f51\uff1b\u6d4b\u8bd5\u7f51\u7528 ",(0,r.jsx)(n.code,{children:"0xC4"}),"\uff09"]}),"\n",(0,r.jsx)(n.li,{children:"checksum\uff1a\u53cc SHA256 \u53d6\u524d 4 \u5b57\u8282"}),"\n",(0,r.jsx)(n.li,{children:"Base58Check \u7f16\u7801\u5f97\u5230\u5730\u5740"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u793a\u4f8b-redeemscript2-of-3-\u591a\u7b7e",children:"\u793a\u4f8b redeemScript\uff082-of-3 \u591a\u7b7e\uff09"}),"\n",(0,r.jsxs)(n.p,{children:["\u7ed3\u6784\uff1a",(0,r.jsx)(n.code,{children:"OP_2 <P1> <P2> <P3> OP_3 OP_CHECKMULTISIG"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u82e5 3 \u4e2a\u538b\u7f29\u516c\u94a5 ",(0,r.jsx)(n.code,{children:"P1/P2/P3"})," \u4e3a 33 \u5b57\u8282\uff1a"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"OP_2 = 0x52"}),"\uff0c",(0,r.jsx)(n.code,{children:"OP_3 = 0x53"}),"\uff0c",(0,r.jsx)(n.code,{children:"OP_CHECKMULTISIG = 0xAE"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u6bcf\u4e2a\u516c\u94a5\u524d\u653e\u957f\u5ea6\u524d\u7f00 ",(0,r.jsx)(n.code,{children:"0x21"}),"\uff0833 \u5341\u8fdb\u5236\uff09"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["redeemScript \u5341\u516d\u8fdb\u5236\u5927\u81f4\u4e3a\uff1a\n",(0,r.jsx)(n.code,{children:"52 21 <P1> 21 <P2> 21 <P3> 53 AE"})]}),"\n",(0,r.jsx)(n.p,{children:"\u6267\u884c HASH160 \u540e\u6309\u4e0a\u6587\u89c4\u5219\u7f16\u7801\u6210\u5730\u5740\u5373\u53ef\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u63d0\u793a\uff1a\u4e3a\u751f\u6210\u7a33\u5b9a\u7684\u591a\u7b7e\u5730\u5740\uff0c\u63a8\u8350\u6309 BIP-67 \u5bf9\u516c\u94a5\u8fdb\u884c\u5b57\u5178\u5e8f\u6392\u5e8f\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"python-\u7247\u6bb5\u4ece-redeemscript-\u751f\u6210-p2sh-\u5730\u5740",children:"Python \u7247\u6bb5\uff08\u4ece redeemScript \u751f\u6210 P2SH \u5730\u5740\uff09"}),"\n",(0,r.jsx)(n.p,{children:"\u4ec5\u6f14\u793a Base58Check \u4e0e HASH160\uff0c\u5bf9\u5e94\u6784\u9020 redeemScript \u7684\u903b\u8f91\u81ea\u884c\u5b9e\u73b0\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from hashlib import sha256, new as hashlib_new\n\nALPHABET = b'123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'\nALPHABET_IDX = {ALPHABET[i]: i for i in range(58)}\n\ndef b58encode(b: bytes) -> str:\n    n = int.from_bytes(b, 'big')\n    out = []\n    while n:\n        n, r = divmod(n, 58)\n        out.append(ALPHABET[r])\n    pad = len(b) - len(b.lstrip(b'\\0'))\n    return (ALPHABET[:1] * pad + bytes(reversed(out or [ALPHABET[0]]))).decode()\n\ndef b58check(payload: bytes) -> str:\n    checksum = sha256(sha256(payload).digest()).digest()[:4]\n    return b58encode(payload + checksum)\n\ndef hash160(b: bytes) -> bytes:\n    return hashlib_new('ripemd160', sha256(b).digest()).digest()\n\ndef p2sh_address_from_redeem_script(redeem_script_hex: str, mainnet: bool = True) -> str:\n    rs = bytes.fromhex(redeem_script_hex)\n    script_hash = hash160(rs)\n    version = b'\\x05' if mainnet else b'\\xC4'\n    payload = version + script_hash\n    return b58check(payload)\n\n# \u793a\u4f8b\uff1aP2SH-P2WPKH redeemScript\uff08v0\uff0c20\u5b57\u8282\uff09\ndef redeem_script_p2wpkh(pubkey_hex: str) -> str:\n    pub = bytes.fromhex(pubkey_hex)\n    h160 = hash160(pub)\n    return (b'\\x00' + b'\\x14' + h160).hex()  # 0x00 + push20 + h160\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5e38\u89c1\u9519\u8bef\u4e0e\u6392\u67e5",children:"\u5e38\u89c1\u9519\u8bef\u4e0e\u6392\u67e5"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5c06\u516c\u94a5\u54c8\u5e0c\u5f53\u4f5c scriptHash\uff1aP2SH \u7684\u54c8\u5e0c\u5bf9\u8c61\u662f redeemScript\uff08\u811a\u672c\uff09\uff0c\u4e0d\u662f\u516c\u94a5\u3002"}),"\n",(0,r.jsxs)(n.li,{children:["\u7248\u672c\u5b57\u8282\u9519\u8bef\uff1a\u4e3b\u7f51 ",(0,r.jsx)(n.code,{children:"0x05"}),"\u3001\u6d4b\u8bd5\u7f51 ",(0,r.jsx)(n.code,{children:"0xC4"}),"\uff1b\u4e0d\u8981\u4e0e P2PKH \u7684 ",(0,r.jsx)(n.code,{children:"0x00/0x6f"})," \u6df7\u6dc6\u3002"]}),"\n",(0,r.jsx)(n.li,{children:"\u5fd8\u8bb0\u5728 scriptSig \u4e2d\u9644\u5e26 redeemScript\uff08\u975e\u5d4c\u5957\u9694\u79bb\u89c1\u8bc1\u573a\u666f\uff09\u3002"}),"\n",(0,r.jsx)(n.li,{children:"P2SH-P2WPKH/P2WSH \u6df7\u6dc6 witness \u4e0e scriptSig \u7684\u653e\u7f6e\u4f4d\u7f6e\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5bf9 redeemScript \u5148\u505a Base58 \u6216\u9519\u8bef\u7f16\u7801\u540e\u518d\u54c8\u5e0c\uff08\u5e94\u76f4\u63a5\u5bf9\u539f\u59cb\u5b57\u8282\u505a HASH160\uff09\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u76f8\u5173",children:"\u76f8\u5173"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["P2PKH\uff08",(0,r.jsx)(n.code,{children:"1\u2026/m|n\u2026"}),"\uff09\uff1a\u57fa\u4e8e\u516c\u94a5\u54c8\u5e0c"]}),"\n",(0,r.jsxs)(n.li,{children:["P2WPKH/P2WSH\uff08",(0,r.jsx)(n.code,{children:"bc1q\u2026/tb1q\u2026"}),"\uff09\uff1aBech32\uff08v0 witness\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["P2TR\uff08",(0,r.jsx)(n.code,{children:"bc1p\u2026"}),"\uff09\uff1aBech32m\uff08v1 witness\uff09"]}),"\n",(0,r.jsx)(n.li,{children:"BIP-16\uff08P2SH \u6fc0\u6d3b\uff09\u3001BIP-13\uff08P2SH \u5730\u5740\u683c\u5f0f\uff09\u3001BIP-141\uff08\u9694\u79bb\u89c1\u8bc1\uff09"}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>l});var s=i(96540);const r={},c=s.createContext(r);function d(e){const n=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);