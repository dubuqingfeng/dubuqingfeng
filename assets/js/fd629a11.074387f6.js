"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[6013],{54832:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>o,contentTitle:()=>c,default:()=>p,frontMatter:()=>t,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Wiki/programming/rust/memory/pin-self-referential","title":"pin-self-referential","description":"Pin \u4e0e\u81ea\u5f15\u7528\u7c7b\u578b","source":"@site/docs/Wiki/programming/rust/memory/pin-self-referential.md","sourceDirName":"Wiki/programming/rust/memory","slug":"/Wiki/programming/rust/memory/pin-self-referential","permalink":"/docs/Wiki/programming/rust/memory/pin-self-referential","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"layout-repr-niches","permalink":"/docs/Wiki/programming/rust/memory/layout-repr-niches"},"next":{"title":"pointers-slices-safety","permalink":"/docs/Wiki/programming/rust/memory/pointers-slices-safety"}}');var s=i(74848),l=i(28453);const t={},c=void 0,o={},d=[{value:"Pin \u4e0e\u81ea\u5f15\u7528\u7c7b\u578b",id:"pin-\u4e0e\u81ea\u5f15\u7528\u7c7b\u578b",level:3},{value:"\u80cc\u666f",id:"\u80cc\u666f",level:4},{value:"Unpin \u4e0e Pin",id:"unpin-\u4e0e-pin",level:4},{value:"\u81ea\u5f15\u7528\u4e0e\u6295\u5f71\uff08Projection\uff09",id:"\u81ea\u5f15\u7528\u4e0e\u6295\u5f71projection",level:4},{value:"\u4e0e async \u7684\u5173\u7cfb",id:"\u4e0e-async-\u7684\u5173\u7cfb",level:4},{value:"\u4e0d\u53d8\u91cf\u4e0e\u9677\u9631",id:"\u4e0d\u53d8\u91cf\u4e0e\u9677\u9631",level:4}];function u(n){const e={code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h3,{id:"pin-\u4e0e\u81ea\u5f15\u7528\u7c7b\u578b",children:"Pin \u4e0e\u81ea\u5f15\u7528\u7c7b\u578b"}),"\n",(0,s.jsx)(e.h4,{id:"\u80cc\u666f",children:"\u80cc\u666f"}),"\n",(0,s.jsx)(e.p,{children:"\u67d0\u4e9b\u7c7b\u578b\u4e00\u65e6\u6784\u9020\uff0c\u5176\u4e2d\u7684\u6307\u9488/\u5f15\u7528\u6307\u5411\u81ea\u8eab\u5185\u90e8\u6570\u636e\uff1b\u82e5\u5bf9\u8c61\u79fb\u52a8\u5219\u5f15\u7528\u5931\u6548\uff08\u60ac\u5782\uff09\u3002Rust \u9ed8\u8ba4\u53ef\u79fb\u52a8\uff0c\u9700\u8981\u201c\u56fa\u5b9a\u201d\u4ee5\u4fdd\u8bc1\u5730\u5740\u7a33\u5b9a\u3002"}),"\n",(0,s.jsx)(e.h4,{id:"unpin-\u4e0e-pin",children:"Unpin \u4e0e Pin"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"Unpin"}),"\uff1a\u7c7b\u578b\u53ef\u4ee5\u5b89\u5168\u5730\u88ab\u79fb\u52a8\uff08\u5927\u591a\u6570\u7c7b\u578b\u9ed8\u8ba4\u5b9e\u73b0\uff09\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"Pin<P<T>>"}),"\uff1a\u5bf9 ",(0,s.jsx)(e.code,{children:"T"})," \u505a\u201c\u4e0d\u52a8\u6027\u201d\u627f\u8bfa\uff0c\u524d\u63d0\u662f ",(0,s.jsx)(e.code,{children:"T: !Unpin"})," \u6216\u6211\u4eec\u5e0c\u671b\u5f3a\u5236\u5176\u4e0d\u88ab\u79fb\u52a8\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:["\u5e38\u89c1\u5bb9\u5668\uff1a",(0,s.jsx)(e.code,{children:"Pin<Box<T>>"}),"\u3001",(0,s.jsx)(e.code,{children:"Pin<&mut T>"}),"\u3001",(0,s.jsx)(e.code,{children:"Pin<Arc<T>>"}),"\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u6784\u9020\uff1a"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"use std::pin::Pin;\n\nlet x = Box::pin(/* T \u503c */); // \u5c06 T \u56fa\u5b9a\u5728\u5806\u4e0a\nlet p: Pin<Box<T>> = x;\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u81ea\u5f15\u7528\u4e0e\u6295\u5f71projection",children:"\u81ea\u5f15\u7528\u4e0e\u6295\u5f71\uff08Projection\uff09"}),"\n",(0,s.jsxs)(e.p,{children:["\u5bf9 ",(0,s.jsx)(e.code,{children:"Pin<&mut T>"})," \u83b7\u53d6\u5b57\u6bb5\u7684\u53ef\u53d8\u5f15\u7528\u5e76\u4fdd\u6301\u201c\u4e0d\u52a8\u6027\u201d\u4e0d\u53d8\u5f0f\u9700\u8981\u201c\u6295\u5f71\u201d\u3002\u63a8\u8350\u4f7f\u7528\uff1a"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"pin-project"})," \u6216 ",(0,s.jsx)(e.code,{children:"pin-project-lite"})," \u5b8f\uff0c\u5b89\u5168\u5730\u4e3a\u5b57\u6bb5\u751f\u6210 ",(0,s.jsx)(e.code,{children:"Pin"})," \u6295\u5f71\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"use pin_project::pin_project;\nuse std::pin::Pin;\n\n#[pin_project]\nstruct MyFut {\n    #[pin]\n    inner: SomeFuture,\n    buf: Vec<u8>,\n}\n\nimpl std::future::Future for MyFut {\n    type Output = ();\n    fn poll(self: Pin<&mut Self>, cx: &mut std::task::Context<'_>) -> std::task::Poll<()> {\n        let this = self.project();\n        // this.inner \u7684\u7c7b\u578b\u4e3a Pin<&mut SomeFuture>\n        this.inner.poll(cx)\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h4,{id:"\u4e0e-async-\u7684\u5173\u7cfb",children:"\u4e0e async \u7684\u5173\u7cfb"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"async fn"})," \u751f\u6210 ",(0,s.jsx)(e.code,{children:"!Unpin"})," \u7684 ",(0,s.jsx)(e.code,{children:"Future"}),"\uff08\u5305\u542b\u6808\u4e0a\u72b6\u6001\u673a\uff0c\u81ea\u5f15\u7528\u98ce\u9669\uff09\uff0c\u6267\u884c\u5668\u901a\u8fc7 ",(0,s.jsx)(e.code,{children:"Pin<&mut _>"})," \u8fdb\u884c ",(0,s.jsx)(e.code,{children:"poll"}),"\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.h4,{id:"\u4e0d\u53d8\u91cf\u4e0e\u9677\u9631",children:"\u4e0d\u53d8\u91cf\u4e0e\u9677\u9631"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u4e00\u65e6 ",(0,s.jsx)(e.code,{children:"T"})," \u88ab pin\uff0c\u9664\u975e ",(0,s.jsx)(e.code,{children:"T: Unpin"}),"\uff0c\u4e0d\u5f97\u901a\u8fc7\u5b89\u5168\u4ee3\u7801\u628a\u5b83\u79fb\u52a8\u5230\u65b0\u5730\u5740\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:["\u7981\u6b62\u901a\u8fc7 ",(0,s.jsx)(e.code,{children:"mem::replace"}),"/",(0,s.jsx)(e.code,{children:"ptr::write"})," \u7b49\u7ed5\u8fc7 Pin \u7684\u201c\u4e0d\u52a8\u6027\u201d\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:["\u624b\u5199 ",(0,s.jsx)(e.code,{children:"unsafe"})," \u5b9e\u73b0\u6295\u5f71\u6613\u51fa\u9519\uff0c\u4f18\u5148\u4f7f\u7528\u5b8f\u5e93\u3002"]}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(u,{...n})}):u(n)}},28453:(n,e,i)=>{i.d(e,{R:()=>t,x:()=>c});var r=i(96540);const s={},l=r.createContext(s);function t(n){const e=r.useContext(l);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:t(n.components),r.createElement(l.Provider,{value:e},n.children)}}}]);