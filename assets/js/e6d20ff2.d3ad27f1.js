"use strict";(globalThis.webpackChunkdubuqingfeng=globalThis.webpackChunkdubuqingfeng||[]).push([[2270],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var r=t(96540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},81202:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"Wiki/programming/nodejs/ops/observability","title":"observability","description":"\u53ef\u89c2\u6d4b\u6027\uff08\u65e5\u5fd7/\u6307\u6807/\u8ffd\u8e2a\uff09","source":"@site/docs/Wiki/programming/nodejs/ops/observability.md","sourceDirName":"Wiki/programming/nodejs/ops","slug":"/Wiki/programming/nodejs/ops/observability","permalink":"/docs/Wiki/programming/nodejs/ops/observability","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"esm-cjs","permalink":"/docs/Wiki/programming/nodejs/modules/esm-cjs"},"next":{"title":"memory-gc","permalink":"/docs/Wiki/programming/nodejs/performance/memory-gc"}}');var s=t(74848),i=t(28453);const o={},l=void 0,c={},a=[{value:"\u53ef\u89c2\u6d4b\u6027\uff08\u65e5\u5fd7/\u6307\u6807/\u8ffd\u8e2a\uff09",id:"\u53ef\u89c2\u6d4b\u6027\u65e5\u5fd7\u6307\u6807\u8ffd\u8e2a",level:3},{value:"\u8981\u70b9",id:"\u8981\u70b9",level:4},{value:"\u793a\u4f8b\uff1a\u7ed3\u6784\u5316\u65e5\u5fd7\u4e0e\u8bf7\u6c42\u4e0a\u4e0b\u6587",id:"\u793a\u4f8b\u7ed3\u6784\u5316\u65e5\u5fd7\u4e0e\u8bf7\u6c42\u4e0a\u4e0b\u6587",level:4},{value:"\u793a\u4f8b\uff1a\u6307\u6807\u4e0e /metrics \u66b4\u9732",id:"\u793a\u4f8b\u6307\u6807\u4e0e-metrics-\u66b4\u9732",level:4},{value:"\u793a\u4f8b\uff1aOpenTelemetry",id:"\u793a\u4f8bopentelemetry",level:4}];function d(e){const n={code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"\u53ef\u89c2\u6d4b\u6027\u65e5\u5fd7\u6307\u6807\u8ffd\u8e2a",children:"\u53ef\u89c2\u6d4b\u6027\uff08\u65e5\u5fd7/\u6307\u6807/\u8ffd\u8e2a\uff09"}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u7ed3\u6784\u5316\u65e5\u5fd7 + \u6307\u6807 + \u5206\u5e03\u5f0f\u8ffd\u8e2a\u6784\u5efa\u7aef\u5230\u7aef\u53ef\u89c2\u6d4b\u6027\uff0c\u4fbf\u4e8e\u95ee\u9898\u5b9a\u4f4d\u4e0e\u5bb9\u91cf\u89c4\u5212\u3002"}),"\n",(0,s.jsx)(n.h4,{id:"\u8981\u70b9",children:"\u8981\u70b9"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u65e5\u5fd7\uff1apino/winston\u3001JSON \u683c\u5f0f\u3001\u91c7\u6837\u4e0e\u8131\u654f\uff1b"}),"\n",(0,s.jsx)(n.li,{children:"\u6307\u6807\uff1aprom-client\u3001\u76f4\u65b9\u56fe/\u6458\u8981\u3001\u4e8b\u4ef6\u5faa\u73af\u5ef6\u8fdf\uff1b"}),"\n",(0,s.jsx)(n.li,{children:"\u8ffd\u8e2a\uff1aOpenTelemetry\u3001HTTP/DB \u5ba2\u6237\u7aef\u81ea\u52a8\u6ce8\u5165\uff1b"}),"\n",(0,s.jsx)(n.li,{children:"\u4e0a\u4e0b\u6587\uff1aAsyncLocalStorage \u8d2f\u7a7f\u8bf7\u6c42\u4e0a\u4e0b\u6587\uff1b"}),"\n",(0,s.jsx)(n.li,{children:"\u6c47\u805a\uff1aELK/EFK\u3001Prometheus/Grafana\u3001Tempo/Jaeger\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u793a\u4f8b\u7ed3\u6784\u5316\u65e5\u5fd7\u4e0e\u8bf7\u6c42\u4e0a\u4e0b\u6587",children:"\u793a\u4f8b\uff1a\u7ed3\u6784\u5316\u65e5\u5fd7\u4e0e\u8bf7\u6c42\u4e0a\u4e0b\u6587"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"import pino from 'pino';\nimport { AsyncLocalStorage } from 'node:async_hooks';\n\nconst als = new AsyncLocalStorage();\nconst logger = pino();\n\napp.use((req, res, next) => {\n  const ctx = { reqId: crypto.randomUUID() };\n  als.run(ctx, next);\n});\n\nfunction log() {\n  const ctx = als.getStore() || {};\n  logger.info({ ...ctx, msg: 'hello' });\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"\u793a\u4f8b\u6307\u6807\u4e0e-metrics-\u66b4\u9732",children:"\u793a\u4f8b\uff1a\u6307\u6807\u4e0e /metrics \u66b4\u9732"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"import client from 'prom-client';\nconst h = new client.Histogram({ name: 'http_duration_ms', help: 'latency', buckets: [50,100,200,500,1000] });\napp.use((req, res, next) => { const end = h.startTimer(); res.on('finish', () => end()); next(); });\napp.get('/metrics', async (_, res) => res.type('text/plain').send(await client.register.metrics()));\n"})}),"\n",(0,s.jsx)(n.h4,{id:"\u793a\u4f8bopentelemetry",children:"\u793a\u4f8b\uff1aOpenTelemetry"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// \u7b80\u5316\u793a\u4f8b\uff1asdk \u521d\u59cb\u5316 + http \u81ea\u52a8\u6ce8\u5165\nconst { NodeSDK } = require('@opentelemetry/sdk-node');\nconst { HttpInstrumentation } = require('@opentelemetry/instrumentation-http');\nnew NodeSDK({ instrumentations: [new HttpInstrumentation()] }).start();\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5b9e\u8df5\uff1a\u6309\u7aef\u70b9/\u79df\u6237/\u73af\u5883\u5206\u79bb\u770b\u677f\u4e0e\u91c7\u6837\uff0c\u63a7\u5236\u6210\u672c\uff1b\u6838\u5fc3\u8def\u5f84\u9ad8\u91c7\u6837\uff0c\u8fb9\u7f18\u8def\u5f84\u4f4e\u91c7\u6837\u3002"})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);