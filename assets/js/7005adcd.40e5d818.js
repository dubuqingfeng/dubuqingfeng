"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[2809],{50493:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>a,frontMatter:()=>d,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"Wiki/programming/nodejs/deploy/pm2-docker","title":"pm2-docker","description":"\u8fdb\u7a0b\u7ba1\u7406\u4e0e\u5bb9\u5668\u5316","source":"@site/docs/Wiki/programming/nodejs/deploy/pm2-docker.md","sourceDirName":"Wiki/programming/nodejs/deploy","slug":"/Wiki/programming/nodejs/deploy/pm2-docker","permalink":"/docs/Wiki/programming/nodejs/deploy/pm2-docker","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"worker-threads","permalink":"/docs/Wiki/programming/nodejs/concurrency/worker-threads"},"next":{"title":"fs","permalink":"/docs/Wiki/programming/nodejs/io/fs"}}');var o=r(74848),s=r(28453);const d={},l=void 0,c={},t=[{value:"\u8fdb\u7a0b\u7ba1\u7406\u4e0e\u5bb9\u5668\u5316",id:"\u8fdb\u7a0b\u7ba1\u7406\u4e0e\u5bb9\u5668\u5316",level:3},{value:"\u8981\u70b9",id:"\u8981\u70b9",level:4},{value:"\u793a\u4f8b\uff1a\u591a\u9636\u6bb5 Dockerfile\uff08\u6700\u5c0f\u955c\u50cf\uff09",id:"\u793a\u4f8b\u591a\u9636\u6bb5-dockerfile\u6700\u5c0f\u955c\u50cf",level:4},{value:"\u793a\u4f8b\uff1a\u4f18\u96c5\u505c\u6b62",id:"\u793a\u4f8b\u4f18\u96c5\u505c\u6b62",level:4}];function p(e){const n={code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h3,{id:"\u8fdb\u7a0b\u7ba1\u7406\u4e0e\u5bb9\u5668\u5316",children:"\u8fdb\u7a0b\u7ba1\u7406\u4e0e\u5bb9\u5668\u5316"}),"\n",(0,o.jsx)(n.p,{children:"\u4f7f\u7528 PM2/systemd \u7ba1\u7406\u8fdb\u7a0b\uff0c\u5bb9\u5668\u5316\u90e8\u7f72\u4e0e\u8d44\u6e90\u9650\u5236\uff0c\u7ed3\u5408\u53cd\u5411\u4ee3\u7406\u4e0e\u7f16\u6392\u3002"}),"\n",(0,o.jsx)(n.h4,{id:"\u8981\u70b9",children:"\u8981\u70b9"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u8fdb\u7a0b\u7ba1\u7406\uff1aPM2 cluster \u6a21\u5f0f\u3001\u65e5\u5fd7\u8f6e\u8f6c\u3001\u5065\u5eb7\u68c0\u67e5\uff1b"}),"\n",(0,o.jsx)(n.li,{children:"\u4f18\u96c5\u505c\u6b62\uff1a\u4fe1\u53f7\uff08SIGTERM/SIGINT\uff09\u4e0e\u5173\u95ed\u94a9\u5b50\uff1b"}),"\n",(0,o.jsx)(n.li,{children:"\u5bb9\u5668\u5316\uff1a\u591a\u9636\u6bb5\u6784\u5efa\u3001\u6700\u5c0f\u955c\u50cf\u3001\u53ea\u8bfb\u6587\u4ef6\u7cfb\u7edf\uff1b"}),"\n",(0,o.jsx)(n.li,{children:"\u7f16\u6392\uff1aK8s HPA/\u8d44\u6e90\u914d\u989d\u3001\u63a2\u9488\u4e0e\u6eda\u52a8\u5347\u7ea7\uff1b"}),"\n",(0,o.jsx)(n.li,{children:"\u4ee3\u7406\uff1aNginx/Caddy\u3001TLS \u4e0e HTTP/2\u3002"}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"\u793a\u4f8b\u591a\u9636\u6bb5-dockerfile\u6700\u5c0f\u955c\u50cf",children:"\u793a\u4f8b\uff1a\u591a\u9636\u6bb5 Dockerfile\uff08\u6700\u5c0f\u955c\u50cf\uff09"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-Dockerfile",children:'FROM node:22-alpine AS build\nWORKDIR /app\nCOPY package.json package-lock.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\nFROM node:22-alpine\nWORKDIR /app\nENV NODE_ENV=production\nCOPY --from=build /app/package.json ./\nCOPY --from=build /app/node_modules ./node_modules\nCOPY --from=build /app/dist ./dist\nCMD ["node", "dist/server.js"]\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u793a\u4f8b\u4f18\u96c5\u505c\u6b62",children:"\u793a\u4f8b\uff1a\u4f18\u96c5\u505c\u6b62"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:"const server = app.listen(3000);\nprocess.on('SIGTERM', () => {\n  server.close(() => process.exit(0));\n  setTimeout(() => process.exit(1), 10_000).unref();\n});\n"})}),"\n",(0,o.jsx)(n.p,{children:"\u53d1\u5e03\u7b56\u7565\uff1a\u84dd\u7eff/\u91d1\u4e1d\u96c0\u7ed3\u5408\u5065\u5eb7\u68c0\u67e5\uff1b\u8d44\u6e90\u9650\u5236\u4f7f\u7528 CPU shares/\u5185\u5b58\u4e0a\u9650\uff0c\u89c2\u5bdf\u4e8b\u4ef6\u5faa\u73af\u5ef6\u8fdf\u4e0e p99 \u53d8\u5316\u3002"})]})}function a(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>l});var i=r(96540);const o={},s=i.createContext(o);function d(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:d(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);