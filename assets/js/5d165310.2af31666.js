"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[9926],{85187:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>t,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"Wiki/programming/rust/memory/pointers-slices-safety","title":"pointers-slices-safety","description":"\u6307\u9488\u4e0e\u5207\u7247\u5b89\u5168\u8fb9\u754c\uff08offset/add/wrapping \u4e0e fromrawparts \u4e0d\u53d8\u91cf\uff09","source":"@site/docs/Wiki/programming/rust/memory/pointers-slices-safety.md","sourceDirName":"Wiki/programming/rust/memory","slug":"/Wiki/programming/rust/memory/pointers-slices-safety","permalink":"/docs/Wiki/programming/rust/memory/pointers-slices-safety","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"pin-self-referential","permalink":"/docs/Wiki/programming/rust/memory/pin-self-referential"},"next":{"title":"unsafe-and-model","permalink":"/docs/Wiki/programming/rust/memory/unsafe-and-model"}}');var s=r(74848),l=r(28453);const t={},d=void 0,c={},a=[{value:"\u6307\u9488\u4e0e\u5207\u7247\u5b89\u5168\u8fb9\u754c\uff08offset/add/wrapping \u4e0e from_raw_parts \u4e0d\u53d8\u91cf\uff09",id:"\u6307\u9488\u4e0e\u5207\u7247\u5b89\u5168\u8fb9\u754coffsetaddwrapping-\u4e0e-from_raw_parts-\u4e0d\u53d8\u91cf",level:3},{value:"\u6307\u9488\u7b97\u672f\u4e0e\u8fb9\u754c",id:"\u6307\u9488\u7b97\u672f\u4e0e\u8fb9\u754c",level:4},{value:"from_raw_parts \u7684\u4e0d\u53d8\u91cf",id:"from_raw_parts-\u7684\u4e0d\u53d8\u91cf",level:4},{value:"\u62f7\u8d1d\u8bed\u4e49\u4e0e\u91cd\u53e0",id:"\u62f7\u8d1d\u8bed\u4e49\u4e0e\u91cd\u53e0",level:4},{value:"\u5bf9\u9f50\u4e0e\u672a\u5bf9\u9f50\u8bbf\u95ee",id:"\u5bf9\u9f50\u4e0e\u672a\u5bf9\u9f50\u8bbf\u95ee",level:4},{value:"\u5207\u7247\u4e0e\u957f\u5ea6",id:"\u5207\u7247\u4e0e\u957f\u5ea6",level:4},{value:"\u5bb9\u5668\u4e0e\u5931\u6548\u5f15\u7528",id:"\u5bb9\u5668\u4e0e\u5931\u6548\u5f15\u7528",level:4}];function o(e){const n={code:"code",h3:"h3",h4:"h4",li:"li",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"\u6307\u9488\u4e0e\u5207\u7247\u5b89\u5168\u8fb9\u754coffsetaddwrapping-\u4e0e-from_raw_parts-\u4e0d\u53d8\u91cf",children:"\u6307\u9488\u4e0e\u5207\u7247\u5b89\u5168\u8fb9\u754c\uff08offset/add/wrapping \u4e0e from_raw_parts \u4e0d\u53d8\u91cf\uff09"}),"\n",(0,s.jsx)(n.h4,{id:"\u6307\u9488\u7b97\u672f\u4e0e\u8fb9\u754c",children:"\u6307\u9488\u7b97\u672f\u4e0e\u8fb9\u754c"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ptr.add(n)"}),"/",(0,s.jsx)(n.code,{children:"ptr.sub(n)"}),"\uff1a\u4ee5\u5143\u7d20\u4e3a\u5355\u4f4d\u504f\u79fb\uff0c\u4e0d\u5141\u8bb8\u8d8a\u8fc7\u5206\u914d\u8fb9\u754c\uff08allocation\uff09\uff0c\u6ea2\u51fa UB\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ptr.offset(n)"}),"\uff1a\u5141\u8bb8\u8d1f\u504f\u79fb\uff0c\u9700\u66f4\u8c28\u614e\uff1b\u65b0\u4ee3\u7801\u4f18\u5148 ",(0,s.jsx)(n.code,{children:"add/sub"}),"\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"wrapping_add/sub"}),"\uff1a\u5728\u673a\u5668\u6574\u6570\u4e0a\u73af\u7ed5\uff0c\u4f46\u4ecd\u5fc5\u987b\u4fdd\u6301 provenance \u548c\u5728\u540c\u4e00 allocation \u5185\u7684\u7ea6\u675f\u3002"]}),"\n",(0,s.jsx)(n.li,{children:"\u201cone-past-end\u201d \u4ec5\u5bf9\u539f\u59cb\u6307\u9488\u5728\u6bd4\u8f83/\u518d\u504f\u79fb\u65f6\u5408\u6cd5\uff1b\u5f15\u7528\u4e0d\u5141\u8bb8\u6307\u5411\u8d8a\u754c\u4f4d\u7f6e\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"from_raw_parts-\u7684\u4e0d\u53d8\u91cf",children:"from_raw_parts \u7684\u4e0d\u53d8\u91cf"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"// SAFETY: \u8c03\u7528\u8005\u5fc5\u987b\u4fdd\u8bc1\uff1a\n// 1) ptr \u6e90\u81ea\u540c\u4e00\u5206\u914d\uff08provenance\uff09\u4e14\u5bf9\u9f50\u6ee1\u8db3 T \u7684\u5bf9\u9f50\u8981\u6c42\n// 2) len \u5143\u7d20\u5747\u5df2\u521d\u59cb\u5316\uff08\u8bfb\u53d6\u672a\u521d\u59cb\u5316\u5185\u5b58\u662f UB\uff09\n// 3) \u5185\u5b58\u4e0d\u5728\u5207\u7247\u5b58\u6d3b\u671f\u95f4\u88ab\u91ca\u653e/\u6536\u56de\n// 4) \u5bf9\u4e8e &mut [T]\uff0c\u8fd8\u9700\u72ec\u5360\u8bbf\u95ee\uff08\u65e0\u522b\u540d\u53ef\u53d8\uff09\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use std::slice;\nuse std::mem::MaybeUninit;\n\nunsafe fn view_initialized(ptr: *const u32, len: usize) -> &'static [u32] {\n    slice::from_raw_parts(ptr, len)\n}\n\n// \u5bf9\u4e8e\u90e8\u5206\u521d\u59cb\u5316\u7684\u7f13\u51b2\u533a\uff0c\u5148\u7528 MaybeUninit \u518d\u5b89\u5168\u8f6c\u6362\uff1a\nunsafe fn assume_init_slice(buf: &[MaybeUninit<u32>]) -> &[u32] {\n    // \u4fdd\u8bc1\u524d n \u9879\u5df2\u521d\u59cb\u5316\n    MaybeUninit::slice_assume_init_ref(buf)\n}\n"})}),"\n",(0,s.jsx)(n.h4,{id:"\u62f7\u8d1d\u8bed\u4e49\u4e0e\u91cd\u53e0",children:"\u62f7\u8d1d\u8bed\u4e49\u4e0e\u91cd\u53e0"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ptr::copy_nonoverlapping"}),"\uff08memcpy\uff09\uff1a\u6e90\u4e0e\u76ee\u6807\u4e0d\u5e94\u91cd\u53e0\uff1b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ptr::copy"}),"\uff08memmove\uff09\uff1a\u5141\u8bb8\u91cd\u53e0\uff0c\u4f46\u7a0d\u6162\uff1b"]}),"\n",(0,s.jsxs)(n.li,{children:["\u7528\u4e8e ",(0,s.jsx)(n.code,{children:"T"}),"\uff0c\u9700\u786e\u4fdd\u6309\u4f4d\u590d\u5236\u7b26\u5408 ",(0,s.jsx)(n.code,{children:"T"})," \u7684\u6709\u6548\u6027\uff08\u5bf9\u975e ",(0,s.jsx)(n.code,{children:"Copy"})," \u7c7b\u578b\u8c28\u614e\uff09\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5bf9\u9f50\u4e0e\u672a\u5bf9\u9f50\u8bbf\u95ee",children:"\u5bf9\u9f50\u4e0e\u672a\u5bf9\u9f50\u8bbf\u95ee"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u6307\u9488\u5fc5\u987b\u6ee1\u8db3 ",(0,s.jsx)(n.code,{children:"align_of::<T>()"}),"\uff1b\u4e0d\u6ee1\u8db3\u65f6\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"read_unaligned/write_unaligned"}),"\u3002"]}),"\n",(0,s.jsx)(n.li,{children:"packed \u7ed3\u6784\u4f53\u5b57\u6bb5\u8bbf\u95ee\u9700\u6309\u5b57\u8282\u5904\u7406\u6216\u4f7f\u7528 unaligned \u539f\u8bed\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5207\u7247\u4e0e\u957f\u5ea6",children:"\u5207\u7247\u4e0e\u957f\u5ea6"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u5207\u7247\u957f\u5ea6\u6309\u5143\u7d20\u8ba1\uff1b\u603b\u5b57\u8282 = ",(0,s.jsx)(n.code,{children:"len * size_of::<T>()"})," \u4e0d\u80fd\u8d8a\u8fc7 allocation \u5927\u5c0f\u3002"]}),"\n",(0,s.jsx)(n.li,{children:"\u7a7a\u5207\u7247\u7684\u6307\u9488\u53ef\u4e3a\u4efb\u610f\u975e\u7a7a\u5bf9\u9f50\u6307\u9488\uff08\u4e0d\u4f1a\u88ab\u89e3\u5f15\u7528\uff09\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"\u5bb9\u5668\u4e0e\u5931\u6548\u5f15\u7528",children:"\u5bb9\u5668\u4e0e\u5931\u6548\u5f15\u7528"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Vec"})," \u7684\u589e\u957f\u4f1a reallocate\uff0c",(0,s.jsx)(n.code,{children:"String"})," \u540c\u7406\uff1b\u6301\u6709\u5143\u7d20\u5f15\u7528\u65f6\u907f\u514d\u89e6\u53d1\u589e\u957f\u64cd\u4f5c\u3002"]}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528\u7d22\u5f15\u6216\u4e0b\u6807\u4f4d\u7f6e\u91cd\u65b0\u83b7\u53d6\u5f15\u7528\uff1b\u6216\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"Vec::reserve"})," \u9884\u7559\u5bb9\u91cf\u907f\u514d\u91cd\u5206\u914d\u3002"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>d});var i=r(96540);const s={},l=i.createContext(s);function t(e){const n=i.useContext(l);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);