"use strict";(self.webpackChunkdubuqingfeng=self.webpackChunkdubuqingfeng||[]).push([[8493],{21774:(n,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>p,frontMatter:()=>c,metadata:()=>e,toc:()=>u});const e=JSON.parse('{"id":"Wiki/programming/golang/concurrency/waitgroup","title":"waitgroup","description":"Sync.WaitGroup","source":"@site/docs/Wiki/programming/golang/concurrency/waitgroup.md","sourceDirName":"Wiki/programming/golang/concurrency","slug":"/Wiki/programming/golang/concurrency/waitgroup","permalink":"/docs/Wiki/programming/golang/concurrency/waitgroup","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"once","permalink":"/docs/Wiki/programming/golang/concurrency/once"},"next":{"title":"context","permalink":"/docs/Wiki/programming/golang/context/"}}');var i=r(74848),o=r(28453);const c={},a=void 0,s={},u=[{value:"Sync.WaitGroup",id:"syncwaitgroup",level:3},{value:"ToC",id:"toc",level:4},{value:"Example",id:"example",level:4},{value:"\u6838\u5fc3\u5185\u5bb9",id:"\u6838\u5fc3\u5185\u5bb9",level:4},{value:"ErrorGroup \u6269\u5c55",id:"errorgroup-\u6269\u5c55",level:4},{value:"\u53c2\u8003\u94fe\u63a5",id:"\u53c2\u8003\u94fe\u63a5",level:4}];function l(n){const t={a:"a",code:"code",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h3,{id:"syncwaitgroup",children:"Sync.WaitGroup"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.a,{href:"https://github.com/golang/go/blob/master/src/sync/waitgroup.go",children:"https://github.com/golang/go/blob/master/src/sync/waitgroup.go"})}),"\n",(0,i.jsx)(t.h4,{id:"toc",children:"ToC"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Example"}),"\n",(0,i.jsx)(t.li,{}),"\n"]}),"\n",(0,i.jsx)(t.h4,{id:"example",children:"Example"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'package main\r\n\r\nimport (\r\n    "fmt"\r\n    "sync"\r\n)\r\nvar wg sync.WaitGroup\r\nfunc handle(num int) {\r\n    defer wg.Done()\r\n    fmt.Println(num, "handle.")\r\n}\r\nfunc main() {\r\n    for i := 0; i < 5; i++ {\r\n        wg.Add(1)\r\n        go handle(i)\r\n    }\r\n    fmt.Println("main goroutine do something.")\r\n    wg.Wait()\r\n    fmt.Println("main goroutine end.")\r\n}\n'})}),"\n",(0,i.jsx)(t.h4,{id:"\u6838\u5fc3\u5185\u5bb9",children:"\u6838\u5fc3\u5185\u5bb9"}),"\n",(0,i.jsx)(t.p,{children:"\u4fe1\u53f7\u91cf\u8ba1\u6570"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"type WaitGroup struct {\r\n\tnoCopy noCopy\r\n\t// 64 \u4f4d\u548c 32 \u4f4d\u4f7f\u7528\u7684\u4e0d\u540c\r\n\tstate1 uint64\r\n\tstate2 uint32\r\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:"Add \u65b9\u6cd5\u7684\u5b9e\u73b0\uff1a"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'func (wg *WaitGroup) Add(delta int) {\r\n\tstatep, semap := wg.state()\r\n\tstate := atomic.AddUint64(statep, uint64(delta)<<32)\r\n\tv := int32(state >> 32)\r\n\tw := uint32(state)\r\n\tif v < 0 {\r\n\t\tpanic("sync: negative WaitGroup counter")\r\n\t}\r\n\tif w != 0 && delta > 0 && v == int32(delta) {\r\n\t\tpanic("sync: WaitGroup misuse: Add called concurrently with Wait")\r\n\t}\r\n\tif v > 0 || w == 0 {\r\n\t\treturn\r\n\t}\r\n\t// This goroutine has set counter to 0 when waiters > 0.\r\n\t// Now there can\'t be concurrent mutations of state:\r\n\t// - Adds must not happen concurrently with Wait,\r\n\t// - Wait does not increment waiters if it sees counter == 0.\r\n\t// Still do a cheap sanity check to detect WaitGroup misuse.\r\n\tif *statep != state {\r\n\t\tpanic("sync: WaitGroup misuse: Add called concurrently with Wait")\r\n\t}\r\n\t// Reset waiters count to 0.\r\n\t*statep = 0\r\n\tfor ; w != 0; w-- {\r\n\t\truntime_Semrelease(semap, false, 0)\r\n\t}\r\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"Done \u7684\u65b9\u6cd5\u662f Add(-1)"}),"\n",(0,i.jsx)(t.p,{children:"Wait \u65b9\u6cd5\u5b9e\u73b0\uff1a"}),"\n",(0,i.jsx)(t.p,{children:"for \u5faa\u73af\u4e0d\u65ad\u68c0\u67e5 state\uff0c\u5982\u679c\u8ba1\u6570\u5668\u4e3a 0\uff0c\u5219\u6240\u6709 goroutine \u5168\u90e8\u6267\u884c\u5b8c\u6bd5\u3002"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'// Wait blocks until the WaitGroup counter is zero.\r\nfunc (wg *WaitGroup) Wait() {\r\n\tstatep, semap := wg.state()\r\n\tfor {\r\n\t\tstate := atomic.LoadUint64(statep)\r\n\t\tv := int32(state >> 32)\r\n\t\tw := uint32(state)\r\n\t\tif v == 0 {\r\n\t\t\treturn\r\n\t\t}\r\n\t\t// Increment waiters count.\r\n\t\tif atomic.CompareAndSwapUint64(statep, state, state+1) {\r\n\t\t\truntime_Semacquire(semap)\r\n\t\t\tif *statep != 0 {\r\n\t\t\t\tpanic("sync: WaitGroup is reused before previous Wait has returned")\r\n\t\t\t}\r\n\t\t\treturn\r\n\t\t}\r\n\t}\r\n}\n'})}),"\n",(0,i.jsx)(t.h4,{id:"errorgroup-\u6269\u5c55",children:"ErrorGroup \u6269\u5c55"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"Go"}),"\u6269\u5c55\u5e93\u901a\u8fc7 ",(0,i.jsx)(t.code,{children:"errorgroup.Group "}),"\u63d0\u4f9b ",(0,i.jsx)(t.code,{children:"ErrorGroup"})," \u539f\u8bed\u7684\u529f\u80fd"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:"func WithContext(ctx context.Context) (*Group, context.Context)\r\nfunc (g *Group) Go(f func() error)\r\nfunc (g *Group) Wait() error\n"})}),"\n",(0,i.jsxs)(t.p,{children:["\u4f1a\u8fd4\u56de\u6240\u6709\u6267\u884c\u4efb\u52a1\u7684",(0,i.jsx)(t.code,{children:"goroutine"}),"\u9047\u5230\u7684\u7b2c\u4e00\u4e2a\u9519\u8bef\u3002"]}),"\n",(0,i.jsx)(t.p,{children:"\u5e95\u5c42\u539f\u7406\u7684\u8bdd\uff1a"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"type Group struct {\r\n    cancel func()\r\n\r\n    wg sync.WaitGroup\r\n\r\n    errOnce sync.Once\r\n    err     error\r\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:"\u901a\u8fc7 sync.Once \u4fdd\u8bc1\u8fd4\u56de\u6240\u6709\u6267\u884c\u4efb\u52a1\u9047\u5230\u7684\u7b2c\u4e00\u4e2a\u9519\u8bef\u3002"}),"\n",(0,i.jsx)(t.h4,{id:"\u53c2\u8003\u94fe\u63a5",children:"\u53c2\u8003\u94fe\u63a5"}),"\n",(0,i.jsx)(t.p,{children:"\u6df1\u5ea6\u89e3\u6790sync WaitGroup\u6e90\u7801"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.a,{href:"https://zhuanlan.zhihu.com/p/352329481",children:"https://zhuanlan.zhihu.com/p/352329481"})})]})}function p(n={}){const{wrapper:t}={...(0,o.R)(),...n.components};return t?(0,i.jsx)(t,{...n,children:(0,i.jsx)(l,{...n})}):l(n)}},28453:(n,t,r)=>{r.d(t,{R:()=>c,x:()=>a});var e=r(96540);const i={},o=e.createContext(i);function c(n){const t=e.useContext(o);return e.useMemo((function(){return"function"==typeof n?n(t):{...t,...n}}),[t,n])}function a(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),e.createElement(o.Provider,{value:t},n.children)}}}]);